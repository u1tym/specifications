言語 python
型のヒント句を付けて

source/python/下にある expense.py に処理を実装して。
処理内容は、expense.pyのコメントに記載している。
不明点は聞いて。

DBは以下のとおり

PostgreSQL

CREATE TABLE auth.users (
    uid               SERIAL      PRIMARY KEY,             -- ユーザID（自動採番）
    uname             VARCHAR(50) NOT NULL UNIQUE,         -- ユーザ名称（ユニーク）
    upass             TEXT        NOT NULL,                -- パスワード
    magic_number      INTEGER,                 -- マジックナンバー（パスワード処理用ランダム数値）
    sequence_number   BIGINT,                  -- シーケンス管理用番号（大きな値も扱えるように）
    last_access_at    TIMESTAMP WITH TIME ZONE -- 最終アクセス日時
);

create table expense.accounts (
    aid          SERIAL PRIMARY KEY,
    uid          INTEGER                      NOT NULL,
    account_name TEXT                         NOT NULL,
    is_deleted   BOOLEAN                      DEFAULT FALSE,
    FOREIGN KEY (uid) REFERENCES auth.users(uid) ON DELETE CASCADE,
    UNIQUE(uid, account_name)
);

create table expense.payments (
    pid                  SERIAL PRIMARY KEY,
    uid                  INTEGER                      NOT NULL,
    payment_name         TEXT                         NOT NULL,
    closing_day          INTEGER,
    payment_offset_month INTEGER,
    payment_day          INTEGER,
    aid                  INTEGER,
    deleted_at           DATE,
    FOREIGN KEY (uid) REFERENCES auth.users(uid) ON DELETE CASCADE,
    FOREIGN KEY (aid) REFERENCES expense.accounts(aid),
    UNIQUE(uid, payment_name)
);


create table expense.transactions (
    tid                  SERIAL PRIMARY KEY,
    uid                  INTEGER                      NOT NULL,
    transaction_date     DATE                         NOT NULL, -- 利用日
    dorder               INTEGER                      NOT NULL, -- transaction_date毎のユニークな連番
    purpose              TEXT                         NOT NULL, -- 用途
    memo                 TEXT,
    pid                  INTEGER,
    amount_spent         INTEGER                      NOT NULL DEFAULT 0,
    aid                  INTEGER,
    amount_received      INTEGER                      NOT NULL DEFAULT 0,
    is_deleted           BOOLEAN                      NOT NULL DEFAULT FALSE,
    FOREIGN KEY (uid) REFERENCES auth.users(uid) ON DELETE CASCADE,
    FOREIGN KEY (pid) REFERENCES expense.payments(pid),
    FOREIGN KEY (aid) REFERENCES expense.accounts(aid),
    UNIQUE(uid, transaction_date, dorder)
);

create or replace function expense.set_transactions_dorder()
returns trigger as $$
begin
  NEW.dorder := (
      select coalesce(max(dorder), 0) + 1
      from expense.transactions
      where uid = NEW.uid and transaction_date = NEW.transaction_date
  );
  return NEW;
end;
$$ LANGUAGE plpgsql;

create trigger trg_set_transaction_dorder
before insert on expense.transactions
for each row
execute function expense.set_transactions_dorder();


create table expense.account_histories (
    hid          SERIAL PRIMARY KEY,
    aid          INTEGER                      NOT NULL,
    payment_date DATE                         NOT NULL,
    dorder       INTEGER                      NOT NULL, -- payment_date毎の連番
    tid          INTEGER                      NOT NULL,
    amount       INTEGER                      NOT NULL DEFAULT 0,
    is_deleted   BOOLEAN                      NOT NULL DEFAULT FALSE,
    FOREIGN KEY (aid) REFERENCES expense.accounts(aid),
    FOREIGN KEY (tid) REFERENCES expense.transactions(tid),
    UNIQUE(aid, payment_date, dorder)
);

create or replace function expense.set_account_histories_dorder()
returns trigger as $$
begin
  NEW.dorder := (
      select coalesce(max(dorder), 0) + 1
      from expense.account_histories
      where aid = NEW.aid and payment_date = NEW.payment_date
  );
  return NEW;
end;
$$ LANGUAGE plpgsql;

create trigger trg_set_account_histories_dorder
before insert on expense.account_histories
for each row
execute function expense.set_account_histories_dorder();
